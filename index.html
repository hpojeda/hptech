<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Orçamento de TI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Para esconder o botão de teste, descomente a linha abaixo */
        /* .dev-only { display: none; } */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="max-w-5xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Gerador de Orçamento</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Crie e compartilhe orçamentos de manutenção de forma rápida e profissional.</p>
        </header>

        <main id="app" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Form Section -->
            <div id="quote-form" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Preencha os Dados</h2>
                    <button id="test-data-btn" class="dev-only bg-yellow-400 text-yellow-900 px-3 py-1 rounded-lg hover:bg-yellow-500 transition text-sm font-semibold">Teste</button>
                </div>

                <form id="main-form" class="space-y-6">
                    <!-- Your/Company Data Section -->
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-300">1. Seus Dados (Salvo Automaticamente)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="yourName" placeholder="Seu Nome" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 text-gray-800 dark:text-gray-200">
                            <input type="text" id="companyName" placeholder="Nome da Empresa" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 text-gray-800 dark:text-gray-200">
                            <input type="tel" id="yourPhone" placeholder="Seu Celular" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 text-gray-800 dark:text-gray-200">
                            <input type="email" id="yourEmail" placeholder="Seu Email" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-purple-500 text-gray-800 dark:text-gray-200">
                        </div>
                    </div>

                    <!-- Client and Equipment Section -->
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-300">2. Dados do Cliente e Equipamento</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="clientName" placeholder="Nome do Cliente" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-800 dark:text-gray-200">
                            <input type="tel" id="clientPhone" placeholder="Celular do Cliente" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-800 dark:text-gray-200">
                            <input type="email" id="clientEmail" placeholder="Email do Cliente" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 col-span-2 text-gray-800 dark:text-gray-200">
                            <input type="text" id="pcBrand" placeholder="Marca do Equipamento" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-800 dark:text-gray-200">
                            <input type="text" id="pcModel" placeholder="Modelo do Equipamento" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 text-gray-800 dark:text-gray-200">
                        </div>
                    </div>
                    
                    <!-- Quick Add Section -->
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-300">3. Itens</h3>
                         <button type="button" id="open-quick-items-modal" class="w-full bg-indigo-500 text-white px-4 py-3 rounded-lg hover:bg-indigo-600 transition shadow font-medium">Adicionar Item Rápido</button>
                    </div>

                    <!-- Manual Add Sections -->
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Serviços Adicionados</h3>
                            <button type="button" id="add-service" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition shadow font-medium">+ Manual</button>
                        </div>
                        <div id="services-list" class="space-y-3"></div>
                    </div>

                    <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Peças Adicionadas</h3>
                            <button type="button" id="add-component" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition shadow font-medium">+ Manual</button>
                        </div>
                        <div id="components-list" class="space-y-3"></div>
                    </div>
                    
                    <!-- Deadlines and Details Section -->
                    <div>
                         <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-300">Prazos e Detalhes</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                             <input type="text" id="parts-deadline" placeholder="Prazo de chegada das peças" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 text-gray-800 dark:text-gray-200">
                             <input type="text" id="service-deadline" placeholder="Prazo de finalização" class="p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 text-gray-800 dark:text-gray-200">
                         </div>
                         <textarea id="details" placeholder="Detalhes, observações, garantia..." class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg h-24 focus:ring-2 focus:ring-indigo-500 text-gray-800 dark:text-gray-200"></textarea>
                    </div>
                </form>
            </div>

            <!-- Output/Preview Section -->
            <div class="space-y-8">
                <div id="quote-output-container" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg relative">
                    <div id="quote-output" class="bg-white dark:bg-gray-800 p-4">
                        <header class="flex justify-between items-start pb-4 border-b-2 border-gray-200 dark:border-gray-700 mb-4">
                            <div>
                               <h2 class="text-2xl font-bold text-gray-900 dark:text-white" id="company-name-output">Sua Empresa</h2>
                               <p class="text-sm text-gray-600 dark:text-gray-400" id="your-name-output">Seu Nome</p>
                               <p class="text-sm text-gray-600 dark:text-gray-400" id="your-contact-output">Seu Contato</p>
                            </div>
                            <div class="text-right">
                               <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Orçamento</h2>
                               <p class="text-sm text-gray-500 dark:text-gray-400">Data: <span id="quote-date"></span></p>
                            </div>
                        </header>
                        <div class="mb-6">
                            <h3 class="font-semibold text-gray-500 dark:text-gray-400 uppercase text-sm mb-2">Cliente</h3>
                            <p id="client-name-output" class="font-medium text-gray-800 dark:text-gray-200">Nome do Cliente</p>
                            <p id="client-contact-output" class="text-gray-600 dark:text-gray-400">Contato</p>
                        </div>
                        <div class="mb-6">
                            <h3 class="font-semibold text-gray-500 dark:text-gray-400 uppercase text-sm mb-2">Equipamento</h3>
                            <p id="pc-brand-model-output" class="font-medium text-gray-800 dark:text-gray-200">Marca - Modelo</p>
                        </div>
                        <div id="services-summary" class="mb-6"></div>
                        <div id="components-summary" class="mb-6"></div>
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                            <h3 class="font-semibold text-gray-500 dark:text-gray-400 uppercase text-sm mb-2">Prazos</h3>
                            <p id="parts-deadline-output" class="text-sm text-gray-700 dark:text-gray-300"></p>
                            <p id="service-deadline-output" class="text-sm text-gray-700 dark:text-gray-300"></p>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                             <h3 class="font-semibold text-gray-500 dark:text-gray-400 uppercase text-sm mb-2">Detalhes</h3>
                             <p id="details-output" class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap">Nenhuma observação.</p>
                        </div>
                        <div id="totals-summary" class="mt-8 pt-4 border-t-2 border-dashed border-gray-300 dark:border-gray-600"></div>
                    </div>
                </div>
                 <!-- Action Buttons -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-lg flex flex-col md:flex-row gap-3 no-print">
                    <button id="generate-pdf" class="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition shadow-md font-bold flex items-center justify-center gap-2">
                        Gerar PDF
                    </button>
                    <button id="share-image" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition shadow-md font-bold flex items-center justify-center gap-2">
                        Compartilhar Imagem
                    </button>
                    <button id="copy-text" class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition shadow-md font-bold flex items-center justify-center gap-2">
                        Copiar Texto
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 translate-y-10 transition-all duration-300"></div>

        <!-- Quick Items Modal -->
        <div id="quick-items-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal" id="modal-content">
                <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Adicionar Item Rápido</h2>
                    <button id="close-quick-items-modal" class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-3xl">&times;</button>
                </header>
                <div class="p-6 overflow-y-auto space-y-6">
                    <div>
                        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">Serviços Comuns</h3>
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="p-3 text-gray-800 dark:text-gray-200">Descrição</th>
                                    <th class="p-3 w-32 text-gray-800 dark:text-gray-200">Valor</th>
                                    <th class="p-3 w-24 text-gray-800 dark:text-gray-200">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="quick-services-table">
                                <!-- Quick services will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">Peças Comuns</h3>
                        <table class="w-full text-left border-collapse">
                             <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="p-3 text-gray-800 dark:text-gray-200">Descrição</th>
                                    <th class="p-3 w-32 text-gray-800 dark:text-gray-200">Valor</th>
                                    <th class="p-3 w-24 text-gray-800 dark:text-gray-200">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="quick-components-table">
                                <!-- Quick components will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- THEME ---
            const applyTheme = () => {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
            applyTheme();
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);


            // --- STATE AND CONSTANTS ---
            const { jsPDF } = window.jspdf;
            
            const QUICK_SERVICES = [
                { desc: 'Formatação e instalação de sistema operacional com backup', price: 150.00 },
                { desc: 'Limpeza interna completa com troca de pasta térmica', price: 120.00 },
                { desc: 'Instalação de SSD com clonagem do sistema', price: 100.00 },
                { desc: 'Reparo em carcaça/dobradiça', price: 180.00 },
            ];

            const QUICK_COMPONENTS = [
                { desc: 'SSD 2.5" SATA 240GB', price: 180.00 },
                { desc: 'SSD M.2 NVMe 512GB', price: 350.00 },
                { desc: 'Memória RAM DDR4 8GB Notebook', price: 250.00 },
                { desc: 'Fonte Carregador Universal', price: 120.00 },
            ];

            // --- DOM ELEMENTS ---
            const mainForm = document.getElementById('main-form');
            const generatePdfBtn = document.getElementById('generate-pdf');
            const shareImageBtn = document.getElementById('share-image');
            const copyTextBtn = document.getElementById('copy-text');
            const toast = document.getElementById('toast');
            const testDataBtn = document.getElementById('test-data-btn');
            
            // Modal elements
            const openModalBtn = document.getElementById('open-quick-items-modal');
            const closeModalBtn = document.getElementById('close-quick-items-modal');
            const modal = document.getElementById('quick-items-modal');
            const modalContent = document.getElementById('modal-content');

            // --- FUNCTIONS ---

            const showToast = (message) => {
                toast.textContent = message;
                toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => {
                     toast.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            };
            
            const saveCompanyData = () => {
                localStorage.setItem('yourName', document.getElementById('yourName').value);
                localStorage.setItem('companyName', document.getElementById('companyName').value);
                localStorage.setItem('yourPhone', document.getElementById('yourPhone').value);
                localStorage.setItem('yourEmail', document.getElementById('yourEmail').value);
            };

            const loadCompanyData = () => {
                document.getElementById('yourName').value = localStorage.getItem('yourName') || '';
                document.getElementById('companyName').value = localStorage.getItem('companyName') || '';
                document.getElementById('yourPhone').value = localStorage.getItem('yourPhone') || '';
                document.getElementById('yourEmail').value = localStorage.getItem('yourEmail') || '';
            };

            const formatCurrency = (value) => {
                if (isNaN(value)) return 'R$ 0,00';
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            };
            
            const formatPhone = (value) => {
                if (!value) return "";
                value = value.replace(/\D/g,'');
                value = value.replace(/^(\d{2})(\d)/g,"($1) $2");
                value = value.replace(/(\d{5})(\d{4})$/,"$1-$2");
                return value;
            }

            const formatCurrencyInput = (input) => {
                let value = input.value.replace(/\D/g, '');
                if (value === '') {
                    input.value = '';
                    return;
                }
                value = (parseInt(value, 10) / 100).toFixed(2) + '';
                value = value.replace('.', ',');
                value = value.replace(/(\d)(?=(\d{3})+(?!\d{2}))/g, '$1.');
                input.value = 'R$ ' + value;
            };

            const createItem = (type, description = '', value = '') => {
                const isService = type === 'service';
                const list = isService ? document.getElementById('services-list') : document.getElementById('components-list');
                const itemDiv = document.createElement('div');
                itemDiv.className = `flex flex-wrap sm:flex-nowrap items-center gap-2 item-${type}`;
                itemDiv.innerHTML = `
                    <input type="text" value="${description}" data-type="description" placeholder="${isService ? 'Descrição do Serviço' : 'Descrição da Peça'}" class="w-full sm:flex-1 p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-1 focus:ring-blue-500 transition text-gray-800 dark:text-gray-200">
                    <input type="text" value="${value ? formatCurrency(value) : ''}" data-type="value" placeholder="Valor (R$)" class="currency-input w-full sm:w-32 p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-1 focus:ring-blue-500 transition text-gray-800 dark:text-gray-200">
                    <button type="button" class="remove-item-btn bg-red-500 text-white h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-lg hover:bg-red-600 transition">&times;</button>
                `;
                list.appendChild(itemDiv);
                itemDiv.querySelector('.currency-input').addEventListener('input', (e) => formatCurrencyInput(e.target));
                updatePreview();
            };

            const getItemsFromDOM = (type) => {
                const list = document.getElementById(`${type}s-list`);
                if (!list) return []; // Guard clause to prevent error if element is not found
                return Array.from(list.querySelectorAll(`.item-${type}`)).map(item => {
                    const desc = item.querySelector('[data-type="description"]').value;
                    const valueStr = item.querySelector('[data-type="value"]').value.replace(/[^\d,]/g, '').replace(',', '.');
                    const value = parseFloat(valueStr) || 0;
                    return { desc, value };
                });
            };

            const updatePreview = () => {
                // Your Data
                document.getElementById('your-name-output').textContent = document.getElementById('yourName').value || 'Seu Nome';
                document.getElementById('company-name-output').textContent = document.getElementById('companyName').value || 'Sua Empresa';
                const yourPhone = document.getElementById('yourPhone').value;
                const yourEmail = document.getElementById('yourEmail').value;
                document.getElementById('your-contact-output').textContent = `${yourPhone}${yourPhone && yourEmail ? ' | ' : ''}${yourEmail}`;

                // Client Data
                document.getElementById('quote-date').textContent = new Date().toLocaleDateString('pt-BR');
                document.getElementById('client-name-output').textContent = document.getElementById('clientName').value || 'Nome do Cliente';
                const clientPhone = document.getElementById('clientPhone').value;
                const clientEmail = document.getElementById('clientEmail').value;
                document.getElementById('client-contact-output').textContent = `${clientPhone}${clientPhone && clientEmail ? ' | ' : ''}${clientEmail}`;

                // Equipment
                const brand = document.getElementById('pcBrand').value || 'Marca';
                const model = document.getElementById('pcModel').value || 'Modelo';
                document.getElementById('pc-brand-model-output').textContent = `${brand} - ${model}`;

                // Deadlines & Details
                document.getElementById('details-output').textContent = document.getElementById('details').value || 'Nenhuma observação.';
                const partsDeadline = document.getElementById('parts-deadline').value;
                document.getElementById('parts-deadline-output').textContent = partsDeadline ? `Previsão de chegada das peças: ${partsDeadline}` : '';
                const serviceDeadline = document.getElementById('service-deadline').value;
                document.getElementById('service-deadline-output').textContent = serviceDeadline ? `Prazo de finalização do serviço: ${serviceDeadline}` : '';

                let servicesTotal = 0;
                let componentsTotal = 0;

                // Services summary
                const servicesSummary = document.getElementById('services-summary');
                servicesSummary.innerHTML = '<div><h3 class="font-semibold text-gray-500 dark:text-gray-400 uppercase text-sm mb-2">Serviços Contratados</h3></div>';
                const serviceItems = getItemsFromDOM('service');
                if(serviceItems.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'w-full text-sm';
                    table.innerHTML = `<thead class="dark:text-gray-200"><tr class="border-b dark:border-gray-700"><th class="text-left py-1 pr-2">Descrição</th><th class="text-right py-1 pl-2">Valor</th></tr></thead><tbody></tbody>`;
                    const tbody = table.querySelector('tbody');
                    serviceItems.forEach(item => {
                        servicesTotal += item.value;
                        if(item.desc) {
                           tbody.innerHTML += `<tr class="dark:text-gray-300"><td class="py-1 pr-2">${item.desc}</td><td class="text-right py-1 pl-2">${formatCurrency(item.value)}</td></tr>`;
                        }
                    });
                    servicesSummary.appendChild(table);
                } else {
                     servicesSummary.innerHTML += '<p class="text-sm text-gray-500 dark:text-gray-400 italic">Nenhum serviço adicionado.</p>';
                }

                // Components summary
                const componentsSummary = document.getElementById('components-summary');
                componentsSummary.innerHTML = '<div><h3 class="font-semibold text-gray-500 dark:text-gray-400 uppercase text-sm mb-2">Peças e Componentes</h3></div>';
                const componentItems = getItemsFromDOM('component');
                if (componentItems.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'w-full text-sm';
                    table.innerHTML = `<thead class="dark:text-gray-200"><tr class="border-b dark:border-gray-700"><th class="text-left py-1 pr-2">Descrição</th><th class="text-right py-1 pl-2">Valor</th></tr></thead><tbody></tbody>`;
                    const tbody = table.querySelector('tbody');
                    componentItems.forEach(item => {
                        componentsTotal += item.value;
                        if(item.desc) {
                            tbody.innerHTML += `<tr class="dark:text-gray-300"><td class="py-1 pr-2">${item.desc}</td><td class="text-right py-1 pl-2">${formatCurrency(item.value)}</td></tr>`;
                        }
                    });
                     componentsSummary.appendChild(table);
                } else {
                    componentsSummary.innerHTML += '<p class="text-sm text-gray-500 dark:text-gray-400 italic">Nenhuma peça adicionada.</p>';
                }

                // Totals
                const totalsSummary = document.getElementById('totals-summary');
                const grandTotal = servicesTotal + componentsTotal;
                totalsSummary.innerHTML = `
                    <div class="flex justify-end mb-2">
                        <span class="text-gray-600 dark:text-gray-400 w-auto pr-4">Subtotal Serviços:</span>
                        <span class="font-semibold text-right w-32 text-gray-800 dark:text-gray-200">${formatCurrency(servicesTotal)}</span>
                    </div>
                    <div class="flex justify-end mb-4">
                        <span class="text-gray-600 dark:text-gray-400 w-auto pr-4">Subtotal Peças:</span>
                        <span class="font-semibold text-right w-32 text-gray-800 dark:text-gray-200">${formatCurrency(componentsTotal)}</span>
                    </div>
                    <div class="flex justify-end items-center">
                        <span class="text-xl font-bold text-gray-800 dark:text-white w-auto pr-4">TOTAL:</span>
                        <span class="text-2xl font-bold text-blue-600 dark:text-blue-400 text-right w-32">${formatCurrency(grandTotal)}</span>
                    </div>
                `;
            };
            
            const populateQuickItems = () => {
                const servicesTable = document.getElementById('quick-services-table');
                const componentsTable = document.getElementById('quick-components-table');
                servicesTable.innerHTML = '';
                componentsTable.innerHTML = '';

                QUICK_SERVICES.forEach(item => {
                    const row = `
                        <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="p-3 text-gray-800 dark:text-gray-200">${item.desc}</td>
                            <td class="p-3 text-gray-800 dark:text-gray-200">${formatCurrency(item.price)}</td>
                            <td class="p-3"><button data-type="service" data-desc="${item.desc}" data-price="${item.price}" class="add-quick-item-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Adicionar</button></td>
                        </tr>
                    `;
                    servicesTable.innerHTML += row;
                });

                QUICK_COMPONENTS.forEach(item => {
                    const row = `
                         <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="p-3 text-gray-800 dark:text-gray-200">${item.desc}</td>
                            <td class="p-3 text-gray-800 dark:text-gray-200">${formatCurrency(item.price)}</td>
                            <td class="p-3"><button data-type="component" data-desc="${item.desc}" data-price="${item.price}" class="add-quick-item-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm">Adicionar</button></td>
                        </tr>
                    `;
                    componentsTable.innerHTML += row;
                });
            };

            const copyQuoteAsText = () => {
                let text = `--- ORÇAMENTO DE MANUTENÇÃO ---\n\n`;
                text += `DE:\n`;
                text += `${document.getElementById('companyName').value || 'N/A'}\n`;
                text += `${document.getElementById('yourName').value || 'N/A'}\n`;
                text += `${document.getElementById('yourPhone').value || 'N/A'} | ${document.getElementById('yourEmail').value || 'N/A'}\n\n`;
                
                text += `PARA:\n`;
                text += `Cliente: ${document.getElementById('clientName').value || 'N/A'}\n`;
                text += `Contato: ${document.getElementById('clientPhone').value || 'N/A'} | ${document.getElementById('clientEmail').value || 'N/A'}\n\n`;
                
                text += `EQUIPAMENTO:\n`;
                text += `${document.getElementById('pcBrand').value || 'N/A'} - ${document.getElementById('pcModel').value || 'N/A'}\n\n`;
                
                let servicesTotal = 0;
                const serviceItems = getItemsFromDOM('service');
                if (serviceItems.length > 0) {
                    text += `--- SERVIÇOS ---\n`;
                    serviceItems.forEach(item => {
                        text += `${item.desc}: ${formatCurrency(item.value)}\n`;
                        servicesTotal += item.value;
                    });
                }

                let componentsTotal = 0;
                const componentItems = getItemsFromDOM('component');
                if (componentItems.length > 0) {
                    text += `\n--- PEÇAS/COMPONENTES ---\n`;
                    componentItems.forEach(item => {
                        text += `${item.desc}: ${formatCurrency(item.value)}\n`;
                        componentsTotal += item.value;
                    });
                }

                text += `\n--- PRAZOS E DETALHES ---\n`;
                text += `Chegada das Peças: ${document.getElementById('parts-deadline').value || 'N/A'}\n`;
                text += `Finalização do Serviço: ${document.getElementById('service-deadline').value || 'N/A'}\n`;
                text += `Detalhes: ${document.getElementById('details').value || 'Nenhuma observação.'}\n\n`;
                
                text += `--- TOTAL ---\n`;
                text += `Subtotal Serviços: ${formatCurrency(servicesTotal)}\n`;
                text += `Subtotal Peças: ${formatCurrency(componentsTotal)}\n`;
                text += `VALOR TOTAL: ${formatCurrency(servicesTotal + componentsTotal)}\n`;
                
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('Texto copiado para a área de transferência!');
                } catch (err) {
                    showToast('Erro ao copiar o texto.');
                }
                document.body.removeChild(textarea);
            };
            
            const fillWithTestData = () => {
                // Clear existing lists
                document.getElementById('services-list').innerHTML = '';
                document.getElementById('components-list').innerHTML = '';

                // Fill company data
                document.getElementById('yourName').value = 'Seu Nome Sobrenome';
                document.getElementById('companyName').value = 'Sua Empresa de TI';
                document.getElementById('yourPhone').value = formatPhone('65999887766');
                document.getElementById('yourEmail').value = 'contato@suaempresa.com';

                // Fill client data
                document.getElementById('clientName').value = 'Cliente de Teste';
                document.getElementById('clientPhone').value = formatPhone('65988776655');
                document.getElementById('clientEmail').value = 'cliente.teste@email.com';
                document.getElementById('pcBrand').value = 'Marca Teste';
                document.getElementById('pcModel').value = 'Modelo X-Test';

                // Add random items
                const service = QUICK_SERVICES[Math.floor(Math.random() * QUICK_SERVICES.length)];
                const component = QUICK_COMPONENTS[Math.floor(Math.random() * QUICK_COMPONENTS.length)];
                createItem('service', service.desc, service.price);
                createItem('component', component.desc, component.price);

                // Fill deadlines and details
                document.getElementById('parts-deadline').value = '5 dias úteis';
                document.getElementById('service-deadline').value = '2 dias após chegada das peças';
                document.getElementById('details').value = 'Orçamento de teste gerado automaticamente. Garantia de 90 dias.';

                updatePreview();
                showToast('Dados de teste preenchidos!');
            };


            // --- EVENT LISTENERS ---
            document.querySelectorAll('input[type="tel"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    e.target.value = formatPhone(e.target.value);
                });
            });
            
            mainForm.addEventListener('input', (e) => {
                if(e.target.id.startsWith('your')) saveCompanyData();
                updatePreview();
            });
            
            document.getElementById('app').addEventListener('click', (e) => {
                if (e.target.closest('.remove-item-btn')) {
                    e.target.closest('div[class*="item-"]').remove();
                    updatePreview();
                }
            });

            document.getElementById('add-service').addEventListener('click', () => createItem('service'));
            document.getElementById('add-component').addEventListener('click', () => createItem('component'));

            openModalBtn.addEventListener('click', () => modal.classList.remove('hidden'));
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.add('hidden');
            });
            
            modalContent.addEventListener('click', (e) => {
                if(e.target.classList.contains('add-quick-item-btn')) {
                    const { type, desc, price } = e.target.dataset;
                    createItem(type, desc, price);
                    showToast(`"${desc}" adicionado.`);
                }
            });

            copyTextBtn.addEventListener('click', copyQuoteAsText);
            testDataBtn.addEventListener('click', fillWithTestData);
            shareImageBtn.addEventListener('click', () => {
                const quoteElement = document.getElementById('quote-output');
                const originalBtnText = shareImageBtn.textContent;
                shareImageBtn.innerHTML = '<div class="loader"></div>';
                shareImageBtn.disabled = true;

                html2canvas(quoteElement, { 
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const link = document.createElement('a');
                    const clientName = document.getElementById('clientName').value || 'cliente';
                    const quoteDate = new Date().toISOString().slice(0, 10);
                    link.download = `Orcamento-${clientName.replace(/\s+/g, '_')}-${quoteDate}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => {
                    console.error('Erro ao gerar imagem:', err);
                    showToast('Erro ao gerar a imagem.');
                }).finally(() => {
                    shareImageBtn.innerHTML = 'Compartilhar Imagem';
                    shareImageBtn.disabled = false;
                });
            });

            generatePdfBtn.addEventListener('click', () => {
                const doc = new jsPDF();
                const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
                const pageWidth = doc.internal.pageSize.width || doc.internal.pageSize.getWidth();
                const margin = 15;
                let cursorY = 0;

                const addHeader = () => {
                    doc.setFontSize(18);
                    doc.setFont(undefined, 'bold');
                    doc.text(document.getElementById('companyName').value || 'Sua Empresa', margin, 20);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(document.getElementById('yourName').value || 'Seu Nome', margin, 26);
                    
                    doc.setFontSize(18);
                    doc.setFont(undefined, 'bold');
                    doc.text('Orçamento', pageWidth - margin, 20, { align: 'right' });
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth - margin, 26, { align: 'right' });
                    
                    doc.setDrawColor(200);
                    doc.line(margin, 32, pageWidth - margin, 32);
                };
                
                addHeader();
                
                cursorY = 45;

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('CLIENTE', margin, cursorY);
                doc.text('EQUIPAMENTO', pageWidth / 2, cursorY);
                
                cursorY += 6;
                doc.setFont(undefined, 'normal');
                doc.text(document.getElementById('clientName').value || 'N/A', margin, cursorY);
                doc.text(`${document.getElementById('pcBrand').value || 'N/A'} - ${document.getElementById('pcModel').value || 'N/A'}`, pageWidth / 2, cursorY);
                
                cursorY += 5;
                const clientPhone = document.getElementById('clientPhone').value;
                const clientEmail = document.getElementById('clientEmail').value;
                doc.text(clientPhone, margin, cursorY);
                cursorY += 5;
                doc.text(clientEmail, margin, cursorY);
                
                cursorY += 10;

                const tableOptions = {
                    theme: 'grid',
                    headStyles: { fillColor: [230, 230, 230], textColor: 20 },
                    columnStyles: {
                        0: { cellWidth: 125 }, 
                        1: { cellWidth: 40, halign: 'right' }
                    },
                    didDrawPage: (data) => {
                        addHeader();
                        cursorY = data.cursor.y;
                    }
                };

                const serviceData = getItemsFromDOM('service').map(item => [item.desc, formatCurrency(item.value)]);
                if (serviceData.length > 0) {
                    doc.autoTable({ ...tableOptions, startY: cursorY, head: [['Serviços Contratados', 'Valor']], body: serviceData });
                    cursorY = doc.autoTable.previous ? doc.autoTable.previous.finalY : cursorY;
                }

                const componentData = getItemsFromDOM('component').map(item => [item.desc, formatCurrency(item.value)]);
                if (componentData.length > 0) {
                    const componentStartY = cursorY + (serviceData.length > 0 ? 5 : 0);
                    doc.autoTable({ ...tableOptions, startY: componentStartY, head: [['Peças e Componentes', 'Valor']], body: componentData });
                    cursorY = doc.autoTable.previous ? doc.autoTable.previous.finalY : cursorY;
                }
                
                cursorY += 10;
                
                if (cursorY > pageHeight - 60) { // Check if there's enough space for details and totals
                    doc.addPage();
                    addHeader();
                    cursorY = 45;
                }


                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('PRAZOS E DETALHES', margin, cursorY);
                cursorY += 8;

                doc.setFont(undefined, 'normal');
                const partsDeadline = document.getElementById('parts-deadline').value;
                if(partsDeadline) { doc.text(`Previsão de chegada das peças: ${partsDeadline}`, margin, cursorY); cursorY += 5; }
                const serviceDeadline = document.getElementById('service-deadline').value;
                if(serviceDeadline) { doc.text(`Prazo de finalização do serviço: ${serviceDeadline}`, margin, cursorY); cursorY += 5; }
                const details = doc.splitTextToSize(document.getElementById('details').value || 'Nenhuma observação.', pageWidth - margin * 2);
                doc.text(details, margin, cursorY);
                cursorY += details.length * 5;

                cursorY += 10;
                
                doc.setDrawColor(200);
                doc.line(pageWidth / 2, cursorY, pageWidth - margin, cursorY);
                cursorY += 6;

                const totalsEl = document.getElementById('totals-summary');
                const serviceLabel = totalsEl.querySelector('div:nth-child(1) span:nth-child(1)').textContent;
                const serviceValue = totalsEl.querySelector('div:nth-child(1) span:nth-child(2)').textContent;
                const componentLabel = totalsEl.querySelector('div:nth-child(2) span:nth-child(1)').textContent;
                const componentValue = totalsEl.querySelector('div:nth-child(2) span:nth-child(2)').textContent;
                const totalLabel = totalsEl.querySelector('div:nth-child(3) span:nth-child(1)').textContent;
                const totalValue = totalsEl.querySelector('div:nth-child(3) span:nth-child(2)').textContent;
                const labelX = pageWidth / 2 + 5;
                const valueX = pageWidth - margin;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(serviceLabel, labelX, cursorY);
                doc.text(serviceValue, valueX, cursorY, { align: 'right' });
                cursorY += 6;
                doc.text(componentLabel, labelX, cursorY);
                doc.text(componentValue, valueX, cursorY, { align: 'right' });
                cursorY += 8;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(totalLabel, labelX, cursorY);
                doc.text(totalValue, valueX, cursorY, { align: 'right' });
                
                const clientName = document.getElementById('clientName').value || 'cliente';
                const quoteDate = new Date().toISOString().slice(0, 10);
                const fileName = `Orcamento-${clientName.replace(/\s+/g, '_')}-${quoteDate}.pdf`;
                doc.save(fileName);
            });
            
            // --- INITIALIZATION ---
            loadCompanyData();
            populateQuickItems();
            updatePreview();
        });
    </script>
</body>
</html>
